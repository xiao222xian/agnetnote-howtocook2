# 基于图RAG的智能烹饪助手
[![Python Version](https://img.shields.io/badge/Python-3.8%2B-blue.svg)](https://python.org)
[![License](https://img.shields.io/badge/License-MIT-green.svg)](LICENSE)
[![RAG](https://img.shields.io/badge/Graph-RAG-orange.svg)](https://arxiv.org/abs/2404.16130)

一套基于**图RAG（Graph Retrieval-Augmented Generation）** 构建的智能烹饪问答系统的笔记（ai辅助整理），解决传统向量RAG在复杂烹饪关系推理、多跳查询、跨菜谱关联中的局限性，实现从简单菜谱查询到复杂食材搭配/菜系推理的全场景烹饪问答能力。

系统整合**知识图谱（Neo4j）** +**向量数据库（Milvus）** +**智能查询路由** +**多策略混合检索**，7大模块各司其职、层层衔接，最终为用户提供精准、可解释、实时流式的烹饪回答。

## 🌟 核心优势
### 对比传统向量RAG的突破
传统向量RAG（父子分块策略）仅能回答简单菜谱查询，存在**关系理解缺失、跨文档关联困难、推理能力有限**等问题，本系统通过知识图谱引入实现质的提升：
- ✅ **结构化知识表达**：显式建模菜谱、食材、烹饪步骤、菜系、难度等实体间的语义关系
- ✅ **增强推理能力**：支持多跳推理、子图提取、食材搭配路径查找等复杂查询
- ✅ **智能查询路由**：根据用户查询复杂度自动选择最优检索策略（混合检索/图RAG/组合策略）
- ✅ **事实性与可解释性**：基于图结构的推理路径提供可追溯的答案，避免生成幻觉
- ✅ **高效检索**：融合图索引检索+向量检索+关键词检索，兼顾精准匹配与泛化能力

### 技术选型优势
- 从FAISS切换到**Milvus**：实现生产级向量存储，支持分布式部署、持久化、复杂元数据管理
- 基于**Neo4j**构建烹饪知识图谱：实现实体关系的显式建模与高效遍历
- **LangChain**标准化开发：统一文档格式、检索接口、生成流程，便于扩展
- **流式输出**：默认实时流式生成回答，提升用户体验，失败自动降级为标准模式

## 📊 系统整体架构
采用分层设计，严格遵循**数据层→图谱构建层→检索层→生成层**的数据流方向，7大模块按职责分层，依赖注入式关联，无硬编码耦合：
```
用户自然语言查询 → 智能查询路由器（调度层）→ 检索引擎（检索层：混合检索/图RAG）
↓
底层支撑：图数据准备+图索引构建（图谱构建层） + Milvus向量索引（数据层）
↓
最终输出：LLM生成融合模块（生成层）→ 流式烹饪回答（面向用户）
```

## 📁 项目文件结构
```
code/C9/
├── main.py                          # 系统总控入口：初始化/建知识库/交互式问答
├── config.py                        # 全局配置文件：数据库/模型/分块/检索等所有参数
├── requirements.txt                 # 项目依赖包列表（一键安装）
└── rag_modules/                     # 核心RAG模块包（7大模块）
    ├── __init__.py
    ├── graph_data_preparation.py    # 图数据准备模块：Neo4j数据提取/标准化/分块
    ├── milvus_index_construction.py # Milvus向量索引模块：向量化/索引构建/相似度检索
    ├── hybrid_retrieval.py          # 混合检索模块：实体+主题双层检索，多策略融合
    ├── graph_rag_retrieval.py       # 图RAG检索模块：复杂推理专属，5类菜谱查询模式
    ├── intelligent_query_router.py  # 智能查询路由器：查询分析/策略分发/结果统一
    └── generation_integration.py    # 生成融合模块：流式回答生成，系统最终输出层
```

### 数据文件结构（图谱构建）
```
data/C9/cypher/
├── nodes.csv          # 图谱节点数据（Recipe/Ingredient/CookingStep等）
├── relationships.csv  # 图谱关系数据（菜谱-食材/菜谱-步骤/菜谱-分类等）
└── neo4j_import.cypher # Neo4j批量导入脚本（一键构建知识图谱）
```

## 🛠️ 环境配置与部署
### 1. 依赖安装
```bash
# 安装Python依赖
pip install -r requirements.txt
```

### 2. 数据库环境配置（Docker一键部署）
系统依赖**Neo4j（知识图谱）** 和**Milvus（向量数据库）**，推荐使用Docker快速部署：
#### Neo4j部署
```bash
# 启动Neo4j（含图形化界面，默认端口7474）
docker run -d --name neo4j-cook -p 7474:7474 -p 7687:7687 \
  -e NEO4J_AUTH=neo4j/your_password \
  -e NEO4J_PLUGINS='["apoc"]' \
  neo4j:5.15
```
#### Milvus部署
```bash
# 参考Milvus官方文档启动standalone版（快速体验）
wget https://github.com/milvus-io/milvus/releases/download/v2.4.0/milvus-standalone-docker-compose.yml -O docker-compose.yml
docker-compose up -d
```

### 3. 数据导入
1. 访问Neo4j图形化界面：`http://localhost:7474`（账号密码为启动时配置）
2. 执行`data/C9/cypher/neo4j_import.cypher`脚本，批量导入节点和关系数据
3. 验证数据：执行`MATCH (n) RETURN count(n)`查看节点总数

### 4. 配置文件修改
修改`config.py`中的核心配置，匹配本地环境：
```python
# Neo4j配置
NEO4J_URI = "bolt://localhost:7687"
NEO4J_USER = "neo4j"
NEO4J_PASSWORD = "your_password"

# Milvus配置
MILVUS_HOST = "localhost"
MILVUS_PORT = 19530
MILVUS_COLLECTION_NAME = "cook_rag_collection"

# 模型配置
EMBEDDING_MODEL = "BAAI/bge-small-zh-v1.5"  # 中文向量化模型
LLM_MODEL = "gpt-3.5-turbo"  # 支持所有OpenAI兼容模型/本地大模型
```

## 🚀 快速启动
### 一键运行系统
```bash
# 进入项目根目录
cd code/C9
# 运行主程序
python main.py
```

### 系统运行流程（全自动）
主程序`main.py`会按以下步骤自动执行，无需手动干预：
1. **系统初始化**：按「数据层→存储层→生成层→检索层→调度层」顺序实例化7大模块，建立依赖关联
2. **知识库检测/构建**：
   - 检测Milvus集合是否存在，存在则直接加载，不存在则从Neo4j重建
   - 自动完成：图数据提取→文档标准化→分块→向量索引构建→检索引擎初始化
3. **进入交互式问答**：系统就绪后，提供命令行交互界面，支持用户输入烹饪问题

### 交互式使用说明
系统启动后，输入烹饪问题即可获得回答，支持辅助命令：
```
欢迎使用尝尝咸淡RAG烹饪助手！
可用功能：
   - 'stats' : 查看系统/知识库/路由统计
   - 'rebuild' : 重建知识库（更新数据时使用）
   - 'quit' : 退出系统

您的问题: 宫保鸡丁的做法
```
#### 支持的查询类型
- 简单查询：`红烧肉怎么做`、`番茄炒蛋需要哪些食材`
- 复杂推理：`鸡肉能搭配哪些蔬菜做川菜`、`和鱼香肉丝类似的川菜有哪些`
- 多跳查询：`从番茄到番茄炒蛋的制作路径`、`川菜的核心食材有哪些`
- 分类查询：`所有素菜的菜谱`、`三星难度的粤菜有哪些`

## 🧩 七大核心模块详解
### 模块整体定位与衔接流程
```
用户查询 → 6.智能查询路由器（选策略）→ 分两路：
  ① 简单查询 → 5.混合检索模块（多策略融合）→ 供给1.生成模块
  ② 复杂推理 → 4.图RAG检索模块（图结构推理）→ 供给1.生成模块
↓
底层支撑（所有检索的基础）：
  2.图数据准备模块（Neo4j数据提取）→ 3.图索引构建模块（图检索索引）+7.Milvus向量模块（向量索引）
↓
最终输出：1.生成融合模块 → 流式烹饪回答 → 面向用户
```

### 1. generation_integration.py | LLM生成融合模块
**定位**：系统**最终输出层**，直接面向用户，决定核心体验
**核心职责**：
- 接收检索模块返回的标准化菜谱文档（无需额外处理）
- 将结构化检索结果拼接为LLM上下文，生成人类易读的烹饪回答
- 支持**流式输出**（默认），边生成边显示，失败自动降级为非流式
- 输出格式适配烹饪场景（步骤清晰、食材明确、推理有据）
**核心特点**：把机器检索的结构化数据，转化为普通人能看懂的烹饪解答，是系统的「最终表达者」。

### 2. graph_data_preparation.py | 图数据准备模块
**定位**：系统**数据入口**，图驱动RAG的基础数据来源
**核心职责**：
- 对接Neo4j图数据库，提取菜谱、食材、步骤、分类等所有关联数据
- 将图数据转换为**LangChain标准化Document**，保证后续模块兼容性
- 执行**语义优先分块**（按章节分块，保持语义完整性），生成可向量化的文本块
- 为每个分块添加丰富元数据（从图节点直接获取）和图关联标识（parent_id）
**核心特点**：从图数据库中「提取并标准化」烹饪知识，为后续向量化、索引构建提供可用数据，是系统的「数据原材料处理厂」。

### 3. graph_indexing.py | 图索引构建模块
**定位**：图数据检索核心，为检索层提供**高效的实体/关系检索能力**
**核心流程**：
```
初始化（配置+LLM）→ 构建实体键值对 → 构建关系键值对 → 去重+重建映射 → 对外提供检索接口
```
**核心职责**：
- 将离散的图实体/关系转换为**结构化、可快速检索的键值对索引**
- 对外提供`get_entities_by_key`（按关键词查实体）、`get_relations_by_key`（按关键词查关系）接口
- 为混合检索、图RAG检索提供底层索引支撑
**核心优势**：比原生Neo4j的Cypher检索**更快、更适配自然语言查询**，保留图数据的实体-关系关联特性，是图检索的「专属索引库」。

### 4. graph_rag_retrieval.py | 图RAG检索模块
**定位**：**复杂推理专属检索引擎**，主打多跳关系推理、知识发现，解决传统RAG的核心痛点
**核心创新**：定义**5类菜谱专属查询模式**（枚举类），覆盖绝大多数复杂烹饪查询需求：
| 查询模式       | 英文标识       | 应用场景示例                     |
|----------------|----------------|----------------------------------|
| 实体关系查询   | ENTITY_RELATION | 宫保鸡丁和鸡肉是什么关系？|
| 多跳推理查询   | MULTI_HOP      | 鸡肉能搭配哪些蔬菜做川菜？|
| 子图提取查询   | SUBGRAPH       | 川菜的相关知识有哪些？|
| 路径查找查询   | PATH_FINDING   | 从番茄到番茄炒蛋的制作路径？|
| 聚类相似性查询 | CLUSTERING     | 和鱼香肉丝类似的川菜有哪些？|
**核心职责**：
- 接收用户自然语言查询，通过LLM意图理解转换为**标准化图查询**
- 对接Neo4j执行**多跳遍历、子图提取、图结构推理**，挖掘实体间隐含关联
- 将图检索结果转换为LangChain标准Document，供给生成模块
**核心特点**：专门处理需要深层关系推理的查询，是系统的「核心推理器」。

### 5. hybrid_retrieval.py | 混合检索模块
**定位**：系统**核心检索层**，适配绝大多数常规烹饪查询，多策略融合检索的核心
**核心创新**：采用**实体级+主题级双层检索范式**，融合**图结构检索+BM25关键词检索+Milvus向量检索**三种能力，通过**Round-robin轮询合并**实现多源结果公平融合。
**核心流程**：
```
用户查询 → 提取双层关键词（实体+主题）→ 分层检索（实体级+主题级）→ 增强向量检索 → Round-robin合并 → 输出top_k结果
```
**核心职责**：
- 承上：接收用户自然语言查询，覆盖精准匹配、泛化检索、语义相似等所有常规需求
- 核心：融合多检索策略，解决单一检索「精准性不足、覆盖度有限、泛化能力弱」的痛点
- 启下：将所有结果统一为LangChain Document，添加标准化得分和元数据
**核心特点**：兼顾具体实体的精准匹配（如宫保鸡丁）和抽象主题的泛化检索（如川菜、素菜），是系统的「常规查询检索主力」。

### 6. intelligent_query_router.py | 智能查询路由器
**定位**：系统**顶层检索调度中枢**，连接用户查询与底层检索引擎，是系统的「智能调度指挥官」
**核心职责**：
- 承上：通过LLM**深度分析查询特征**（复杂度、关系密集度、推理需求、实体数量）
- 核心：根据分析结果**智能推荐检索策略**（传统混合/图RAG/组合策略），为每个查询「选对工具」
- 启下：向底层检索引擎分发任务，**统一处理检索结果**，添加标准化路由元数据
- 支撑：提供路由统计、查询分析报告，为系统优化提供可追溯性
**核心流程**：
```
用户查询 → LLM多维度分析 → 生成QueryAnalysis报告 → 策略分发 → 结果后处理 → 统一输出
```
**策略分发规则**：
- 简单信息查找（如查做法）→ 传统混合检索（高效）
- 复杂关系推理（如食材搭配）→ 图RAG检索（精准）
- 中等复杂查询（如菜系+食材）→ 组合策略（融合两者优势）

### 7. milvus_index_construction.py | Milvus向量索引模块
**定位**：系统**向量数据管理核心**，语义检索的技术基础，实现「找相似菜谱/做法」的核心能力
**核心职责**（5大核心功能）：
1. 环境初始化：连接Milvus+加载中文向量化模型（BAAI/bge-small-zh-v1.5）
2. 集合创建：定制菜谱专属Schema（含菜品名、菜系、难度等元数字段）
3. 索引构建：将菜谱分块向量化→批量插入Milvus→构建**HNSW余弦相似度索引**
4. 数据操作：支持相似度检索（可按菜系/难度过滤）、集合管理、统计查看
5. 工程化保障：文本安全截取、批量插入、异常处理，保证稳定性
**核心优势**：对比FAISS，Milvus提供**生产级特性**（持久化、分布式、元数据管理、高并发），适合实际应用场景。

## 🔍 主程序模块调用全流程
主程序`AdvancedGraphRAGSystem`类是系统总控中枢，通过**初始化关联、阶段式调用、依赖注入**将7大模块串联为完整执行链路，严格遵循「数据准备→索引构建→检索初始化→智能调度→结果生成」的逻辑，分为三大核心阶段：

### 阶段1：系统初始化（initialize_system）
**核心目标**：实例化所有模块+建立**依赖关联**（上层模块持有底层模块实例），仅创建实例不处理实际数据。
**调用顺序**：数据层→存储层→生成层→检索层→调度层
1. 实例化`graph_data_preparation`（Neo4j连接）
2. 实例化`milvus_index_construction`（Milvus连接+向量化模型）
3. 实例化`generation_integration`（LLM客户端，所有模块复用）
4. 实例化`hybrid_retrieval`（注入向量模块+图数据模块+LLM）
5. 实例化`graph_rag_retrieval`（注入LLM客户端）
6. 实例化`intelligent_query_router`（注入两大检索引擎+LLM）
7. `graph_indexing`由`graph_data_preparation`**隐式实例化**（后续阶段调用）

**阶段结果**：形成「调度层→检索层→存储/数据层→生成层」的依赖链路，系统进入「待初始化知识库」状态。

### 阶段2：知识库构建/加载（build_knowledge_base）
**核心目标**：模块执行实际业务逻辑→处理数据→构建索引→初始化检索能力→系统进入**可问答就绪状态**。
**核心分支**：检测Milvus集合，存在则加载，不存在则重建（流程一致，仅跳过向量索引构建）
**核心流程**（新建知识库为例）：
1. `graph_data_preparation`：加载Neo4j图数据→构建标准化文档→语义分块→生成chunks
2. `graph_indexing`：隐式构建图实体/关系键值对索引（由步骤1调用）
3. `milvus_index_construction`：将chunks向量化→批量插入Milvus→构建HNSW索引
4. 初始化检索引擎：`hybrid_retrieval.initialize()` + `graph_rag_retrieval.initialize()`
5. 系统状态置为`system_ready = True`

**阶段结果**：完成「图知识索引+向量知识索引」构建，两大检索引擎激活，系统可响应用户查询。

### 阶段3：交互式问答（ask_question_with_routing/run_interactive）
**核心目标**：7大模块**协同工作**，完成从用户查询到流式回答的全流程，是系统的实际使用阶段。
**核心流程**（用户输入问题后）：
1. 主程序调用`query_router.route_query()`，传入问题和top_k参数
2. `intelligent_query_router`：分析查询→推荐策略→调用对应检索引擎
   - 调用`hybrid_retrieval.hybrid_search()`：混合检索引擎执行多策略融合检索
     - 内部调用`graph_indexing`：图实体/关系关键词检索
     - 内部调用`milvus_index_construction`：Milvus向量相似度检索
   - 或调用`graph_rag_retrieval.graph_rag_search()`：图RAG引擎执行复杂推理
     - 内部调用`graph_indexing`：图实体/关系关键词检索
     - 对接Neo4j执行多跳遍历/子图提取
3. `intelligent_query_router`：统一处理检索结果，添加标准化元数据
4. 主程序调用`generation_integration.generate_adaptive_answer_stream()`：流式生成烹饪回答
5. 实时输出回答，同时显示关键信息（使用策略、复杂度、检索结果数、耗时）

### 阶段4：系统退出/资源清理（_cleanup）
用户输入`quit`后，主程序按**上层到下层**顺序调用各模块的`close()`方法，释放资源：
- 关闭Neo4j连接（`graph_data_preparation`/`graph_rag_retrieval`）
- 释放检索器资源（`hybrid_retrieval`）
- 释放Milvus连接（`milvus_index_construction`）
**核心目标**：优雅退出系统，避免内存泄漏和数据库连接占用。

## 📈 系统核心特点
1. **依赖注入，层层绑定**：上层模块通过构造函数注入底层模块实例，无硬编码依赖，便于扩展和替换
2. **阶段式调用，职责明确**：各模块在「初始化→建知识库→问答→清理」阶段的职责固定，流程清晰无交叉
3. **隐式支撑，按需调用**：`graph_indexing`作为底层索引支撑，由其他模块隐式调用，主程序无需关注
4. **统一入口，简化调用**：所有检索请求通过`intelligent_query_router`分发，所有生成请求通过`generation_integration`输出
5. **容错协同，鲁棒性强**：流式生成失败降级、检索失败降级为混合检索、所有异常均有日志记录和友好提示
6. **一键操作，易用性高**：主程序全自动完成初始化、建库、问答，用户仅需运行`python main.py`即可使用

## ❓ 常见问题
### Q1：为什么从FAISS切换到Milvus？
FAISS适合研究/原型开发，但在生产环境存在明显局限：
- FAISS：纯库模式、无持久化、单机限制、元数据支持有限、高并发性能弱
- Milvus：完整数据库功能、云原生分布式架构、丰富元数据支持、生产级监控/备份/恢复特性

### Q2：图RAG的分块策略与传统RAG有何不同？
传统RAG：基于纯文本的父子分块，仅保持文本结构，无显式语义关系
图RAG分块特点：
- 保持图关联：每个chunk通过`parent_id`与图节点绑定
- 语义优先分块：按章节分块，优先保证语义完整性
- 丰富元数据：直接从图节点获取结构化信息（菜系、难度等）
- 双重上下文：既有文本块关系，又有图实体关系信息

### Q3：系统支持本地大模型吗？
支持！只需修改`config.py`中的`LLM_MODEL`配置，适配OpenAI兼容接口的本地大模型（如FastAPI封装的LLaMA/通义千问/文心一言）：
```python
LLM_MODEL = "local-model"
OPENAI_BASE_URL = "http://localhost:8000/v1"  # 本地大模型接口地址
```

### Q4：如何更新知识库？
运行系统后，输入`rebuild`命令，系统会自动删除现有Milvus集合，从Neo4j重新提取数据并构建全新知识库：
```
您的问题: rebuild
⚠️  这将删除现有的向量数据并重新构建，是否继续？(y/N): y
```

## 📋 待优化方向
1. [ ] 支持多模态数据（菜谱图片嵌入向量索引）
2. [ ] 增加用户反馈机制，基于反馈优化检索策略和生成效果
3. [ ] 支持分布式检索，提升高并发场景下的性能
4. [ ] 增加菜谱推荐功能，基于用户查询和历史记录个性化推荐
5. [ ] 提供Web图形化界面，提升用户体验


## 🤝 感谢
本项目为本人学习记录的笔记，原开源项目地址：https://github.com/datawhalechina/all-in-rag/blob/main/docs/chapter9/

---
**如果本项目对你有帮助，欢迎Star⭐支持！**